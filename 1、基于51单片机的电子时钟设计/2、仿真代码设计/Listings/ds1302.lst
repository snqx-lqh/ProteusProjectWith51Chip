C51 COMPILER V9.60.0.0   DS1302                                                            07/03/2022 14:52:35 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE DS1302
OBJECT MODULE PLACED IN .\Objects\ds1302.obj
COMPILER INVOKED BY: D:\software\Program\Keil5\C51\BIN\C51.EXE ds1302.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRIN
                    -T(.\Listings\ds1302.lst) OBJECT(.\Objects\ds1302.obj)

line level    source

   1          #include "DS1302.h"
   2          
   3          //为1时写入初始设置的time[]变量中的时间，要是为0则初始不写入
   4          #define FIRST_WRITE 1
   5          
   6          u8 code readaddre[7]={0x81,0x83,0x85,0x87,0x89,0x8b,0x8d};
   7          u8 code writeaddre[7]={0x80,0x82,0x84,0x86,0x88,0x8a,0x8c};
   8          u8 time[7]={0x55,0X59,0x22,0x09,0x07,0x06,0x20};//秒，分，时，日，月，周，年
   9          u8 second,minute,hour,day,month,week,year;//存储实际的时间日期
  10          u8 secondTemp,minuteTemp,hourTemp,dayTemp,monthTemp,weekTemp,yearTemp;//存储修改时的时间日期
  11          
  12          void ds1302write(u8 addre,u8 dat)
  13          {
  14   1              u8 i;
  15   1              RST=0;
  16   1              _nop_();
  17   1              SCK=0;
  18   1              _nop_();
  19   1              RST=1;
  20   1              _nop_();
  21   1              for (i=0;i<8;i++)
  22   1              {
  23   2                      IO=addre&0x01;
  24   2                      addre>>=1;
  25   2                      SCK=1;
  26   2                      _nop_();
  27   2                      SCK=0;
  28   2                      _nop_();
  29   2              }
  30   1              for (i=0;i<8;i++)
  31   1              {
  32   2                      IO=dat&0x01;
  33   2                      dat>>=1;
  34   2                      SCK=1;
  35   2                      _nop_();
  36   2                      SCK=0;
  37   2                      _nop_();
  38   2              }
  39   1              RST=0;
  40   1      }
  41          u8 ds1302read(u8 addre)
  42          {
  43   1              u8 i,dat1,dat;
  44   1              RST=0;
  45   1              _nop_();
  46   1              SCK=0;
  47   1              _nop_();
  48   1              RST=1;
  49   1              _nop_();
  50   1              for (i=0;i<8;i++)
  51   1              {
  52   2                      IO=addre&0x01;
  53   2                      addre>>=1;
  54   2                      SCK=1;
C51 COMPILER V9.60.0.0   DS1302                                                            07/03/2022 14:52:35 PAGE 2   

  55   2                      _nop_();
  56   2                      SCK=0;
  57   2                      _nop_();
  58   2              }
  59   1              _nop_();
  60   1              for (i=0;i<8;i++)
  61   1              {
  62   2                      dat1=IO;
  63   2                      dat=(dat>>1)|(dat1<<7);
  64   2                      SCK=1;
  65   2                      _nop_();
  66   2                      SCK=0;
  67   2                      _nop_();
  68   2              }
  69   1              RST=0;
  70   1              _nop_();
  71   1              SCK=1;
  72   1              _nop_();
  73   1              IO=1;
  74   1              _nop_();
  75   1              IO=0;
  76   1              _nop_();
  77   1              return dat;
  78   1      }
  79          
  80          void ds1302init()
  81          {
  82   1      #if FIRST_WRITE == 1
  83   1              u8 i;
  84   1              ds1302write(0x8e,0x00);
  85   1              for (i=0;i<7;i++)
  86   1              {
  87   2                      ds1302write(writeaddre[i],time[i]);
  88   2              }
  89   1              ds1302write(0x8e,0x80);
  90   1      #endif
  91   1      }
  92          
  93          void ds1302readtime()
  94          {
  95   1              u8 i;
  96   1              for (i=0;i<7;i++)
  97   1              {
  98   2                      time[i]=ds1302read(readaddre[i]);
  99   2              }
 100   1              second = (time[0]/16)*10+(time[0]&0x0f);
 101   1              minute = (time[1]/16)*10+(time[1]&0x0f);
 102   1              hour   = (time[2]/16)*10+(time[2]&0x0f);
 103   1              day    = (time[3]/16)*10+(time[3]&0x0f);
 104   1              month  = (time[4]/16)*10+(time[4]&0x0f);
 105   1              week   = (time[5]/16)*10+(time[5]&0x0f);
 106   1              year   = (time[6]/16)*10+(time[6]&0x0f);
 107   1      }
 108          
 109          void ds1302writetime()
 110          {
 111   1              u8 i;
 112   1              ds1302write(0x8e,0x00);
 113   1              time[0] = (((secondTemp/10)<<4) + (secondTemp%10));
 114   1              time[1] = (((minuteTemp/10)<<4) + (minuteTemp%10));
 115   1              time[2] = (((hourTemp/10)<<4)   + (hourTemp%10));
 116   1              time[3] = (((dayTemp/10)<<4)    + (dayTemp%10));
C51 COMPILER V9.60.0.0   DS1302                                                            07/03/2022 14:52:35 PAGE 3   

 117   1              time[4] = (((monthTemp/10)<<4)  + (monthTemp%10));
 118   1              time[5] = (((weekTemp/10)<<4)   + (weekTemp%10));
 119   1              time[6] = (((yearTemp/10)<<4)   + (yearTemp%10));
 120   1              
 121   1              for (i=0;i<7;i++)
 122   1              {
 123   2                      ds1302write(writeaddre[i],time[i]);
 124   2              }
 125   1              ds1302write(0x8e,0x80);
 126   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    535    ----
   CONSTANT SIZE    =     14    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     21    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
